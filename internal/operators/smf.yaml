# Flow:
# 1. UE creates Session resource with desired parameters
# 2. AMF controller:
#    - Validates UE context (GUTIâ†’SUPI, registration state)
#    - Checks authorization (Allowed NSSAI)
#    - Creates SessionContext resource for SMF
# 3. SMF controller:
#    - Retrieves policy from PCF
#    - Merges UE requests with network policy
#      - May reduce requested bit rates
#      - May reject certain QoS flows
#    - Updates Session status with allocated resources
#    - Allocates IP address
#    - Configures UPF (N4 session establishment)
#      - Create GTP-U tunnel endpoint (UPF TEID for N3)
#      - Install packet detection rules (PDR)
#      - Install forwarding action rules (FAR)
#      - Install QoS enforcement rules (QER)
#    - Sets SessionContext status to ready
# 4. AMF controller:
#    - sets Session status based on SessionContext status

controllers:
  ##############################
  #
  # TABLE INIT
  #
  ##############################
  - name: init-active-session-table
    sources:
      - kind: InitActiveSessionTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: test-session
            namespace: test-session
          spec:
            guti: "test-guti-000000000000000"
            nssai: eMBB
            sessionId: 0
            pduSessionType: IPv4
            sscMode: SSC1
            networkConfiguration:
              requests:
                - type: IPConfiguration
                  addressFamily: IPv4  # Internet Protocol Control Protocol
                - type: DNSServer
                  addressFamily: IPv4
            qos:
              flows:
                - name: best-effort-flow
                  fiveQI: BestEffort
              rules: [1,2]
          status:
            conditions:
              validated:
                status: "True"
    target:
      kind: SessionContext

  ##############################
  #
  # Session context controllers
  #
  ##############################
  - name: session-context-handler
    sources:
      - kind: SessionContext
        # predicate: GenerationChanged
      - apiGroup: pcf.view.dcontroller.io
        kind: PolicyTable
    pipeline:
      - "@join": true
      - "@select":
          "@eq": [$.SessionContext.status.conditions.validated.status, "True"]
      - "@project":
          metadata: $.SessionContext.metadata
          spec: $.SessionContext.spec
          status: $.SessionContext.status
          policyTable: $.PolicyTable.spec
      # filter flows: only ConversationalVoice and BestEffort are supported
      - "@project":
          metadata: $.metadata
          status: $.status
          policyTable: $.policyTable
          spec:
            sessionId: $.spec.sessionId
            sscMode: $.spec.sscMode
            guti: $.spec.guti
            networkConfiguration: $.spec.networkConfiguration
            nssai: $.spec.nssai
            pduSessionType: $.spec.pduSessionType
            idle: $.spec.idle
            qos:
              flows:
                "@filter":
                  - "@or":
                      - "@eq": [$$.fiveQI, ConversationalVoice]
                      - "@eq": [$$.fiveQI, BestEffort]
                  - $.spec.qos.flows
              rules: $.spec.qos.rules
          status: $.status
      # map policies
      - "@project":
          metadata: $.metadata
          status: $.status
          spec:
            sessionId: $.spec.sessionId
            sscMode: $.spec.sscMode
            guti: $.spec.guti
            suci: $.spec.suci
            networkConfiguration: $.spec.networkConfiguration
            nssai: $.spec.nssai
            pduSessionType: $.spec.pduSessionType
            idle: $.spec.idle
            qos:
              rules: $.spec.qos.rules
              flows:
                "@map":
                  - "@cond":
                      - "@isnil": $$.bitRates
                      - name: $$.name
                        fiveQI: $$.fiveQI
                      - name: $$.name
                        fiveQI: $$.fiveQI
                        bitRates:
                          uplinkBwKbps: { "@min": [$$.bitRates.uplinkBwKbps, $.policyTable.maxGuaranteeedDownlinkBwKbps] }
                          downlinkBwKbps: { "@min": [$$.bitRates.downlinkBwKbps, $.policyTable.maxGuaranteeedUplinkBwKbps] }
                  - $.spec.qos.flows
          status: $.status
      # allocate IP address and DNS
      - "@project":
          metadata: $.metadata
          status: $.status
          spec: $.spec
          status:
            "@cond":
              - "@eq": [$.spec.pduSessionType, IPv4]
              - conditions:
                  policy:
                    status: "True"
                    reason: PolicyApplied
                    message: PCF policies merged
                  upf:
                    "@cond":
                      - "@not": {"@eq": [$.spec.idle, true]}
                      - status: "True"
                        reason: UPFConfigured
                        message: UPF configured
                      - status: "False"
                        reason: Idle
                        message: "Session idle state requested: UPF configuration removed"
                  validated: $.status.conditions.validated
                guti: $.status.guti
                suci: $.status.suci
                qos: $.spec.qos
                networkConfiguration:
                  ipConfiguration:
                    "@cond":
                      - "@eq": [ "$.spec.networkConfiguration.requests[?(@.type == 'IPConfiguration')].addressFamily", IPv4 ]
                      - ipAddress:
                          "@cond":
                            - "@exists": $.status.networkConfiguration.ipConfiguration.ipAddress
                            - $.status.networkConfiguration.ipConfiguration.ipAddress
                            - "@concat":
                                - "10.45.0."
                                - "@rnd": [2, 255]
                        subnetMask: "255.255.0.0"
                        defaultGateway: "10.45.0.1"
                        mtu: 1500
                  dnsConfiguration:
                    "@cond":
                      - "@eq": [ "$.spec.networkConfiguration.requests[?(@.type == 'DNSServer')].addressFamily", IPv4 ]
                      - primaryDNS: "8.8.8.8"
                        secondaryDNS: "8.8.4.4"
              - conditions:
                  policy:
                    status: "False"
                    reason: AddressFamilyNotSupported
                    message: Only IPv4 address policy is supported
                  validated: $.status.conditions.validated
                  upf: $.status.conditions.upf
                  guti: $.status.guti
                  suci: $.status.suci
    target:
      kind: SessionContext

  - name: upf-notifier
    sources:
      - kind: SessionContext
    pipeline:
      - "@select":
          "@and":
            - "@eq": [$.status.conditions.validated.status, "True"]
            - "@eq": [$.status.conditions.policy.status, "True"]
            - "@eq": [$.status.conditions.upf.status, "True"]
      - "@project":
          metadata: $.metadata
          spec:
            networkConfiguration: $.status.networkConfiguration
            qos: $.status.qos
    target:
      apiGroup: upf.view.dcontroller.io
      kind: Config

  - name: active-session
    sources:
      - kind: SessionContext
    pipeline:
      - "@select":
          "@and":
            - "@eq": [$.status.conditions.validated.status, "True"]
            - "@eq": [$.status.conditions.policy.status, "True"]
      - "@project":
          type: SessionContext
          metadata: $.metadata
          spec:
            name: $.metadata.name
            namespace: $.metadata.namespace
            guti: $.spec.guti
            idle: {"@exists": $.spec.idle}
            sessionId: $.spec.sessionId
      - "@gather":
          - $.type
          - $.spec
      - "@project":
          metadata:
            name: active-sessions
          spec: $.spec
    target:
      kind: ActiveSessionTable
