# state: Rejected | Initialized | Validated | SecurityEstablished | IdentityPending | Authenticated | IdentityResolved | SibscriptionInfoPending | Ready
# status: Authenticated, SubscriptionInfoRetrieved, NetworkSliceSelected, Ready
controllers:
  ##############################
  #
  # TABLE INIT
  #
  ##############################
  - name: initial-supi-to-guti-table
    sources:
      - kind: InitSupiToGutiTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: supi-to-guti
          spec:
            - supi: "imsi-999010000000123"
              guti: "guti-310-170-3F-152-2A-B7C8D9E0"
    target:
      kind: SupiToGutiTable

  ##############################
  #
  # Registration controllers
  #
  ##############################
  - name: register-input
    sources:
      - kind: Registration
        predicate: GenerationChanged
    pipeline:
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            conditions:
              validated: { status: Unknown, message: Pending, reason: Pending }
              authenticated: { status: Unknown, message: Pending, reason: Pending }
              subscriptionInfoRetrieved: { status: Unknown, message: Pending, reason: Pending }
              networkSliceSelected: { status: Unknown, message: Pending, reason: Pending }
              ready: { status: Unknown, message: Pending, reason: Pending }
      - "@project":
          - "$.": $.
          - "@cond":
              - "@eq": ["$.spec.registrationType", "initial"]
              - $.metadata.labels.state: Initialized
              - $.metadata.labels.state: Rejected
                $.status.conditions.validated:
                  status: "False"
                  reason: InvalidRegistrationType
                  message: Only initialization is supported during Registration
    target:
      kind: RegState

  - name: register-validate
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Initialized
    pipeline:
      - "@project":
          - "$.": $.
          - "@cond":
              - "@eq": [$.spec.ueStatus.n1Mode, true]
              - metadata:
                  labels:
                    state: Validated
                status:
                  conditions:
                    validated:
                      status: "True"
                      reason: Validated
                      message: 5G signaling established
              - metadata:
                  labels:
                    state: Rejected
                status:
                  conditions:
                    validated:
                      status: "False"
                      reason: StandardNotSupported
                      message: Only 5G signaling is supported
    target:
      kind: RegState
      type: Patcher

  - name: register-auth
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Validated
    pipeline:
      - "@project":
          - "$.": $.
          - "@cond":
              - "@or":
                  - "@not": { "@eq": [$.spec.mobileIdentity.type, SUCI] }
                  - "@isnil": $.spec.mobileIdentity.value
              - $.metadata.labels.state: Rejected
                "$.status.conditions.authenticated":
                  status: "False"
                  reason: MobileIdentityNotProvided
                  message: Mobile identity is not provided
              - "@cond":
                  - "@or":
                      - "@not": {"@in": [5G-EA2, $.spec.ueSecurityCapability.encryptionAlgorithms]}
                      - "@not": {"@in": [5G-IA2, $.spec.ueSecurityCapability.integrityAlgorithms]}
                  - "$.metadata.labels.state": Rejected
                    "$.status.conditions.authenticated":
                      status: "False"
                      reason: EncyptionNotSupported
                      message: Encryption or integrity algorithm not supported
                  - "$.metadata.labels.state": SecurityEstablished
    target:
      kind: RegState
      type: Patcher

  - name: register-identity-req
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: SecurityEstablished
    pipeline:
      - "@project":
          metadata:
            name: $.metadata.name
            namespace: $.metadata.namespace
          spec:
            suci: $.spec.mobileIdentity.value
            registration: $.
    target:
      apiGroup: ausf.view.dcontroller.io
      kind: MobileIdentity

  - name: register-identity-handler
    sources:
      - apiGroup: ausf.view.dcontroller.io
        kind: MobileIdentity
        labelSelector:
          matchLabels:
            state: Ready
    pipeline:
      - "@project":
          - "$.": $.spec.registration
          - "@cond":
              - "@eq": [ "$.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - "$.metadata.labels.state": IdentityPending  # requesting GUTI
                "$.spec.supi": $.status.supi
                "$.status.conditions.authenticated":
                  status: "True"
                  reason: Authenticated
                  message: UE successfully authenticated
              - "$.metadata.labels.state": Rejected
                "$.status.conditions.authenticated":
                  status: "False"
                  reason: SupiNotFound
                  message:
                    "@concat":
                      - "Failed to establish mobile identify: "
                      - "$.status.conditions[?(@.type == 'Ready')].message"
    target:
      kind: RegState
      type: Patcher

  - name: register-guti-mapping-handler
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: IdentityPending
      - kind: SupiToGutiTable
    pipeline:
      - "@join": true
      - "@project":
          - "$.": $.RegState
          - "@cond":
              - "@has": "$.SupiToGutiTable.spec[?(@.supi == $.RegState.spec.supi)]"
              - "$.metadata.labels.state": IdentityResolved
                "$.spec.guti": "$.SupiToGutiTable.spec[?(@.supi == $.RegState.spec.supi)].guti"
                "$.status.conditions.authenticated":
                  status: "True"
                  reason: AuthenticationSuccess
                  message: "UE successfully authenticated"
              - $.metadata.labels.state: Rejected
                "$.status.conditions.authenticated":
                  status: "False"
                  reason: MobileIdentityFailed
                  message: "Failed to establish mobile identify: Could not fing GUTI"
    target:
      kind: RegState
      type: Patcher

  - name: register-config-req
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: IdentityResolved
    pipeline:
      - "@project":
          metadata:
            name: $.spec.guti
            namespace: $.metadata.namespace
          spec:
            registration: $.
    target:
      apiGroup: udm.view.dcontroller.io
      kind: Config

  - name: register-config-handler
    sources:
      - apiGroup: udm.view.dcontroller.io
        kind: Config
        labelSelector:
          matchLabels:
            state: Ready
    pipeline:
      - "@project":
          - "$.": $.spec.registration # recover the regstate
          - "@cond":
              - "@eq": [ "$.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - "$.metadata.labels.state": Ready
                "$.status.config": $.status.config
                "$.status.conditions.subscriptionInfoRetrieved":
                    status: "True"
                    reason: ConfigReady
                    message: UE config successfully loaded
              - "$.metadata.labels.state": Rejected
                "$.status.conditions.subscriptionInfoRetrieved":
                    status: "False"
                    reason: ConfigNotFound
                    message:
                      "@concat":
                        - "Failed to load subscription info: "
                        - "$.status.conditions[?(@.type == 'Ready')].status.message"
    target:
      kind: RegState
      type: Patcher

  - name: register-output
    sources:
      - kind: Registration
        predicate: GenerationChanged
      - kind: RegState
        labelSelector:
          matchExpressions:
            - key: state
              operator: In
              values: ["Ready", "Rejected"]
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Registration.metadata.name, $.RegState.metadata.name]
            - "@eq": [$.Registration.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          metadata:
            name: $.RegState.metadata.name
            namespace: $.RegState.metadata.namespace
            labels: $.Registration.metadata.labels
            annotations: $.Registration.metadata.annotations
          spec: $.RegState.spec
          status:
            conditions:
              - "@cond":
                  - "@eq": ["$.RegState.metadata.labels.state", Ready]
                  - type: Ready
                    status: "True"
                    reason: RegistrationSuccessful
                    message: Registration successful
                  - type: Ready
                    status: "False"
                    reason: RegistrationFailed
                    message: Registration failed
                    # message:
                    #   "@concat": ["Registration failed with status: ", $.RegState.metadata.labels.state]
              - type: Validated
                status: $.RegState.status.conditions.validated.status
                reason: $.RegState.status.conditions.validated.reason
                message: $.RegState.status.conditions.validated.message
              - type: Authenticated
                status: $.RegState.status.conditions.authenticated.status
                reason: $.RegState.status.conditions.authenticated.reason
                message: $.RegState.status.conditions.authenticated.message
              - type: SubscriptionInfoRetrieved
                status: $.RegState.status.conditions.subscriptionInfoRetrieved.status
                reason: $.RegState.status.conditions.subscriptionInfoRetrieved.reason
                message: $.RegState.status.conditions.subscriptionInfoRetrieved.message
              - type: NetworkSliceSelected
                status: "True"
                reason: NetworkSliceFound
                message: Network slice selected
    target:
      kind: Registration
