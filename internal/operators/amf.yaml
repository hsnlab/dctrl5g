# state: Rejected | Initialized | IdentityResolved | Ready
# status: Authenticated, SubscriptionInfoRetrieved, NetworkSliceSelected, Ready
controllers:
  ##############################
  #
  # TABLE INIT
  #
  ##############################
  - name: initial-supi-to-guti-table
    sources:
      - kind: InitSupiToGutiTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: supi-to-guti
          spec:
            - supi: "imsi-999010000000123"
              guti: "guti-310-170-3F-152-2A-B7C8D9E0"
    target:
      kind: SupiToGutiTable

  ##############################
  #
  # Registration controllers
  #
  ##############################
  - name: register-input
    sources:
      - kind: Registration
        predicate: GenerationChanged
    pipeline:
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            conditions:
              validated: { status: Unknown, message: Pending, reason: Pending }
              authenticated: { status: Unknown, message: Pending, reason: Pending }
              subscriptionInfoRetrieved: { status: Unknown, message: Pending, reason: Pending }
              networkSliceSelected: { status: Unknown, message: Pending, reason: Pending }
              ready: { status: Unknown, message: Pending, reason: Pending }
      - "@project":
          - "$.": $.
          - "@cond":
              - "@eq": ["$.spec.registrationType", "initial"]
              - "@cond":
                  - "@eq": [$.spec.ueStatus.n1Mode, true]
                  - $.metadata.labels.state: Validated
                    $.status.conditions.validated:
                      status: "True"
                      reason: Validated
                      message: 5G signaling established
                  - $.metadata.labels.state: Rejected
                    $.status.conditions.validated:
                      status: "False"
                      reason: StandardNotSupported
                      message: Only 5G signaling is supported
              - $.metadata.labels.state: Rejected
                $.status.conditions.validated:
                  status: "False"
                  reason: InvalidRegistrationType
                  message: Only initialization is supported during Registration
          - "@cond":
              - "@and":
                  - "@eq": [$.spec.mobileIdentity.type, SUCI]
                  - "@not": { "@isnil": $.spec.mobileIdentity.value }
              - "@cond":
                  - "@and":
                      - "@in": [5G-EA2, $.spec.ueSecurityCapability.encryptionAlgorithms]
                      - "@in": [5G-IA2, $.spec.ueSecurityCapability.integrityAlgorithms]
                  - "$.metadata.labels.state": Initialized
                  - "$.metadata.labels.state": Rejected
                    "$.status.conditions.authenticated":
                      status: "False"
                      reason: EncyptionNotSupported
                      message: Encryption or integrity algorithm not supported
              - $.metadata.labels.state: Rejected
                $.status.conditions.authenticated:
                  status: "False"
                  reason: MobileIdentityNotProvided
                  message: Mobile identity is not provided
    target:
      kind: RegState

  - name: register-identity-req
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Initialized
    pipeline:
      - "@project":
          metadata:
            name: $.metadata.name
            namespace: $.metadata.namespace
          spec:
            suci: $.spec.mobileIdentity.value
    target:
      apiGroup: ausf.view.dcontroller.io
      kind: MobileIdentity

  - name: register-identity-handler
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Initialized
      - apiGroup: ausf.view.dcontroller.io
        kind: MobileIdentity
        labelSelector:
          matchLabels:
            state: Ready
      - kind: SupiToGutiTable
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.metadata.name, $.MobileIdentity.metadata.name]
            - "@eq": [$.RegState.metadata.namespace, $.MobileIdentity.metadata.namespace]
      - "@project":
          - "$.": $.RegState
          - "@cond":
              - "@eq": [ "$.MobileIdentity.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - "@cond":
                  - "@has": "$.SupiToGutiTable.spec[?(@.supi == $.MobileIdentity.status.supi)]"
                  - $.metadata.labels.state: IdentityResolved
                    status:
                      conditions:
                        authenticated:
                          status: "True"
                          reason: AuthenticationSuccess
                          message: UE successfully authenticated
                      guti: "$.SupiToGutiTable.spec[?(@.supi == $.MobileIdentity.status.supi)].guti"
                  - $.metadata.labels.state: Rejected
                    $.status.conditions.authenticated:
                      status: "False"
                      reason: MobileIdentityFailed
                      message: "Failed to establish mobile identify: Could not find GUTI"
              - $.metadata.labels.state: Rejected
                $.status.conditions.authenticated:
                  status: "False"
                  reason: SupiNotFound
                  message:
                    "@concat":
                      - "Failed to establish mobile identify: "
                      - "$.MobileIdentity.status.conditions[?(@.type == 'Ready')].message"
    target:
      kind: RegState

  - name: register-config-req
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: IdentityResolved
      - kind: Registration   # added so that Config gets deleted properly
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.metadata.name, $.Registration.metadata.name]
            - "@eq": [$.RegState.metadata.namespace, $.Registration.metadata.namespace]          
      - "@project":
          metadata:
            name: $.RegState.status.guti
            namespace: $.RegState.metadata.namespace
    target:
      apiGroup: udm.view.dcontroller.io
      kind: Config

  - name: register-config-handler
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: IdentityResolved
      - apiGroup: udm.view.dcontroller.io
        kind: Config
        labelSelector:
          matchLabels:
            state: Ready
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Config.metadata.name, $.RegState.status.guti]
            - "@eq": [$.Config.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          - "$.": $.RegState
          - "@cond":
              - "@eq": [ "$.Config.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - $.metadata.labels.state: Ready
                $.status.config: $.Config.status.config
                $.status.conditions.subscriptionInfoRetrieved:
                    status: "True"
                    reason: ConfigReady
                    message: UE config successfully loaded
              - $.metadata.labels.state: Rejected
                $.status.conditions.subscriptionInfoRetrieved:
                    status: "False"
                    reason: ConfigNotFound
                    message:
                      "@concat":
                        - "Failed to load subscription info: "
                        - "$.Config.status.conditions[?(@.type == 'Ready')].status.message"
    target:
      kind: RegState

  - name: register-output
    sources:
      - kind: Registration
        predicate: GenerationChanged
      - kind: RegState
        labelSelector:
          matchExpressions:
            - key: state
              operator: In
              values: ["Ready", "Rejected"]
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Registration.metadata.name, $.RegState.metadata.name]
            - "@eq": [$.Registration.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          metadata:
            name: $.RegState.metadata.name
            namespace: $.RegState.metadata.namespace
            labels: $.Registration.metadata.labels
            annotations: $.Registration.metadata.annotations
          spec: $.RegState.spec
          status:
            conditions:
              - "@cond":
                  - "@eq": ["$.RegState.metadata.labels.state", Ready]
                  - type: Ready
                    status: "True"
                    reason: RegistrationSuccessful
                    message: Registration successful
                  - type: Ready
                    status: "False"
                    reason: RegistrationFailed
                    message: Registration failed
                    # message:
                    #   "@concat": ["Registration failed with status: ", $.RegState.metadata.labels.state]
              - type: Validated
                status: $.RegState.status.conditions.validated.status
                reason: $.RegState.status.conditions.validated.reason
                message: $.RegState.status.conditions.validated.message
              - type: Authenticated
                status: $.RegState.status.conditions.authenticated.status
                reason: $.RegState.status.conditions.authenticated.reason
                message: $.RegState.status.conditions.authenticated.message
              - type: SubscriptionInfoRetrieved
                status: $.RegState.status.conditions.subscriptionInfoRetrieved.status
                reason: $.RegState.status.conditions.subscriptionInfoRetrieved.reason
                message: $.RegState.status.conditions.subscriptionInfoRetrieved.message
              - type: NetworkSliceSelected
                status: "True"
                reason: NetworkSliceFound
                message: Network slice selected
    target:
      kind: Registration
