controllers:
  ##############################
  #
  # TABLE INIT
  #
  ##############################
  - name: init-supi-to-guti-table
    sources:
      - kind: InitSupiToGutiTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: supi-to-guti
          spec:
            - supi: "imsi-999010000000123"
              guti: "guti-310-170-3F-152-2A-B7C8D9E0"
            - supi: "imsi-999010000000124"
              guti: "guti-310-170-3F-152-2A-B7C8D9E1"
    target:
      kind: SupiToGutiTable

  - name: init-active-registration-table
    sources:
      - kind: InitActiveRegistrationTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: test-registration
            namespace: test-registration
            labels:
              state: "Ready"
          spec:
            mobileIdentity:
              type: SUCI
              value: "test-suci-000000000000000"
            status:
              guti: "test-guti-000000000000000"
    target:
      kind: RegState

  ##############################
  #
  # Registration controllers
  # - state: Rejected | Initialized | IdentityResolved | Ready
  # - status: Validated, Authenticated, SubscriptionInfoRetrieved, Ready
  #
  ##############################
  - name: register-input
    sources:
      - kind: Registration
        predicate: GenerationChanged
    pipeline:
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            conditions:
              validated: { status: Unknown, message: Pending, reason: Pending }
              authenticated: { status: Unknown, message: Pending, reason: Pending }
              subscriptionInfoRetrieved: { status: Unknown, message: Pending, reason: Pending }
              ready: { status: Unknown, message: Pending, reason: Pending }
      - "@project":
          - "$.": $.
          - "@cond":
              - "@eq": ["$.spec.registrationType", "initial"]
              - "@cond":
                  - "@eq": [$.spec.ueStatus.n1Mode, true]
                  - "@cond":
                      - "@gt":
                          - "@len":
                              "@filter": [ {"@eq": ["$$.sliceType", "eMBB"]}, "$.spec.requestedNSSAI"]
                          - 0
                      - $.metadata.labels.state: Validated
                        $.status.conditions.validated:
                          status: "True"
                          reason: Validated
                          message: 5G signaling established
                      - $.metadata.labels.state: Rejected
                        $.status.conditions.validated:
                          status: "False"
                          reason: NSSAIRejected
                          message: Only NSSAI eMBB supported
                  - $.metadata.labels.state: Rejected
                    $.status.conditions.validated:
                      status: "False"
                      reason: StandardNotSupported
                      message: Only 5G signaling is supported
              - $.metadata.labels.state: Rejected
                $.status.conditions.validated:
                  status: "False"
                  reason: InvalidRegistrationType
                  message: Only initialization is supported during Registration
          - "@cond":
              - "@and":
                  - "@eq": [$.spec.mobileIdentity.type, SUCI]
                  - "@not": { "@isnil": $.spec.mobileIdentity.value }
              - "@cond":
                  - "@and":
                      - "@in": [5G-EA2, $.spec.ueSecurityCapability.encryptionAlgorithms]
                      - "@in": [5G-IA2, $.spec.ueSecurityCapability.integrityAlgorithms]
                  - "$.metadata.labels.state": Initialized
                  - "$.metadata.labels.state": Rejected
                    "$.status.conditions.authenticated":
                      status: "False"
                      reason: EncyptionNotSupported
                      message: Encryption or integrity algorithm not supported
              - $.metadata.labels.state: Rejected
                $.status.conditions.authenticated:
                  status: "False"
                  reason: MobileIdentityNotProvided
                  message: Mobile identity is not provided
    target:
      kind: RegState

  - name: register-identity-req
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Initialized
      - kind: Registration   # added so that MobileIdentity gets deleted properly
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.metadata.name, $.Registration.metadata.name]
            - "@eq": [$.RegState.metadata.namespace, $.Registration.metadata.namespace]
      - "@project":
          "$.": $.RegState
      - "@project":
          metadata:
            name: $.metadata.name
            namespace: $.metadata.namespace
          spec:
            suci: $.spec.mobileIdentity.value
    target:
      apiGroup: ausf.view.dcontroller.io
      kind: MobileIdentity

  - name: register-identity-handler
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Initialized
      - apiGroup: ausf.view.dcontroller.io
        kind: MobileIdentity
        labelSelector:
          matchLabels:
            state: Ready
      - kind: SupiToGutiTable
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.metadata.name, $.MobileIdentity.metadata.name]
            - "@eq": [$.RegState.metadata.namespace, $.MobileIdentity.metadata.namespace]
      - "@project":
          - "$.": $.RegState
          - "@cond":
              - "@eq": [ "$.MobileIdentity.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - "@cond":
                  - "@has": "$.SupiToGutiTable.spec[?(@.supi == $.MobileIdentity.status.supi)]"
                  - $.metadata.labels.state: IdentityResolved
                    status:
                      conditions:
                        authenticated:
                          status: "True"
                          reason: AuthenticationSuccess
                          message: UE successfully authenticated
                      guti: "$.SupiToGutiTable.spec[?(@.supi == $.MobileIdentity.status.supi)].guti"
                  - $.metadata.labels.state: Rejected
                    $.status.conditions.authenticated:
                      status: "False"
                      reason: MobileIdentityFailed
                      message: "Failed to establish mobile identify: Could not find GUTI"
              - $.metadata.labels.state: Rejected
                $.status.conditions.authenticated:
                  status: "False"
                  reason: SupiNotFound
                  message: "Failed to establish mobile identify: SUPI not found"
    target:
      kind: RegState

  - name: register-config-req
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: IdentityResolved
      - kind: Registration   # added so that Config gets deleted properly
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.metadata.name, $.Registration.metadata.name]
            - "@eq": [$.RegState.metadata.namespace, $.Registration.metadata.namespace]          
      - "@project":
          metadata:
            name: $.RegState.status.guti
            namespace: $.RegState.metadata.namespace
    target:
      apiGroup: udm.view.dcontroller.io
      kind: Config

  - name: register-config-handler
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: IdentityResolved
      - apiGroup: udm.view.dcontroller.io
        kind: Config
        labelSelector:
          matchLabels:
            state: Ready
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Config.metadata.name, $.RegState.status.guti]
            - "@eq": [$.Config.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          - "$.": $.RegState
          - "@cond":
              - "@eq": [ "$.Config.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - $.metadata.labels.state: Ready
                $.status.config: $.Config.status.config
                $.status.conditions.subscriptionInfoRetrieved:
                    status: "True"
                    reason: ConfigReady
                    message: UE config successfully loaded
              - $.metadata.labels.state: Rejected
                $.status.conditions.subscriptionInfoRetrieved:
                    status: "False"
                    reason: ConfigNotFound
                    message:
                      "@concat":
                        - "Failed to load subscription info: "
                        - "$.Config.status.conditions[?(@.type == 'Ready')].status.message"
    target:
      kind: RegState

  - name: active-registration
    sources:
      - kind: RegState
        labelSelector:
          matchLabels:
            state: Ready
    pipeline:
      - "@project":
          type: RegState
          metadata: $.metadata
          spec:
            name: $.metadata.name
            namespace: $.metadata.namespace
            suci: $.spec.mobileIdentity.value
            guti: $.status.guti
      - "@gather":
          - $.type
          - $.spec
      - "@project":
          metadata:
            name: active-registrations
          spec: $.spec
    target:
      kind: ActiveRegistrationTable

  - name: register-output
    sources:
      - kind: Registration
        predicate: GenerationChanged
      - kind: RegState
        labelSelector:
          matchExpressions:
            - key: state
              operator: In
              values: ["Ready", "Rejected"]
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Registration.metadata.name, $.RegState.metadata.name]
            - "@eq": [$.Registration.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          metadata:
            name: $.RegState.metadata.name
            namespace: $.RegState.metadata.namespace
            labels: $.Registration.metadata.labels
            annotations: $.Registration.metadata.annotations
          spec: $.RegState.spec
          status:
            config: $.RegState.status.config
            guti: $.RegState.status.guti
            allowedNSSAI:
              "@filter": [ {"@eq": ["$$.sliceType", "eMBB"]}, "$.RegState.spec.requestedNSSAI"]
            conditions:
              - "@cond":
                  - "@eq": ["$.RegState.metadata.labels.state", Ready]
                  - type: Ready
                    status: "True"
                    reason: RegistrationSuccessful
                    message: Registration successful
                  - type: Ready
                    status: "False"
                    reason: RegistrationFailed
                    message: Registration failed
                    # message:
                    #   "@concat": ["Registration failed with status: ", $.RegState.metadata.labels.state]
              - type: Validated
                status: $.RegState.status.conditions.validated.status
                reason: $.RegState.status.conditions.validated.reason
                message: $.RegState.status.conditions.validated.message
              - type: Authenticated
                status: $.RegState.status.conditions.authenticated.status
                reason: $.RegState.status.conditions.authenticated.reason
                message: $.RegState.status.conditions.authenticated.message
              - type: SubscriptionInfoRetrieved
                status: $.RegState.status.conditions.subscriptionInfoRetrieved.status
                reason: $.RegState.status.conditions.subscriptionInfoRetrieved.reason
                message: $.RegState.status.conditions.subscriptionInfoRetrieved.message
    target:
      kind: Registration


  ##############################
  #
  # Session controllers
  # - state: Rejected | Validated | Registered | IdentityResolved | Ready
  # - status: PolicyApplied, UPFConfigured, Ready
  #
  # ##############################
  - name: session-input
    sources:
      - kind: Session
        predicate: GenerationChanged
      - kind: SupiToGutiTable
      - kind: ActiveRegistrationTable
    pipeline:
      - "@join": true
      - "@project":
          metadata: $.Session.metadata
          spec: $.Session.spec
          status:
            conditions:
              validated: { status: Unknown, message: Pending, reason: Pending }
              policy: { status: Unknown, message: Pending, reason: Pending }
              upf: { status: Unknown, message: Pending, reason: Pending }
              ready: { status: Unknown, message: Pending, reason: Pending }
          guti2Supi: $.SupiToGutiTable.spec
          activeRegistrations: $.ActiveRegistrationTable.spec
      - "@project":
          - "$.": $.
          - "@cond":
              - "@or":
                  - "@isnil": $.spec.networkConfiguration
                  - "@isnil": $.spec.qos
                  - "@isnil": $.spec.qos.flows
                  - "@isnil": $.spec.qos.rules
              - $.metadata.labels.state: Rejected
                $.status.conditions.validated:
                  status: "False"
                  reason: InvalidSession
                  message: Failed to validate Session spec
              - "@cond":
                  - "@not": { "@eq": [ $.spec.nssai, eMBB ]}
                  - $.metadata.labels.state: Rejected
                    $.status.conditions.validated:
                      status: "False"
                      reason: NSSAINotPermitted
                      message: Network slice not permitted
                  - "@cond":
                      - "@isnil": $.spec.guti
                      - $.metadata.labels.state: Rejected
                        $.status.conditions.validated:
                          status: "False"
                          reason: GUTINotSpeficied
                          message: GUTI not specified
                      - "@cond":
                          - "@isnil": "$.activeRegistrations[?(@.guti == $.spec.guti)]"
                          - $.metadata.labels.state: Rejected
                            $.status.conditions.validated:
                              status: "False"
                              reason: Unregistered
                              message: Registration not found
                          - "@cond":
                              - "@isnil": "$.guti2Supi[?(@.guti == $.spec.guti)]"
                              - $.metadata.labels.state: Rejected
                                $.status.conditions.validated:
                                  status: "False"
                                  reason: SUPINotFound
                                  message: SUPI not found
                              - $.metadata.labels.state: Validated
                                $.status.conditions.validated:
                                  status: "True"
                                  reason: Validated
                                  message: Session request validated
                                $.status.supi: "$.guti2Supi[?(@.guti == $.spec.guti)].supi"
                                $.status.guti: $.spec.guti
                                $.status.suci: "$.activeRegistrations[?(@.guti == $.spec.guti)].suci"
                                $.status.name: "$.activeRegistrations[?(@.guti == $.spec.guti)].name"
                                $.status.namespace: "$.activeRegistrations[?(@.guti == $.spec.guti)].namespace"
      - "@project": # remove tables
          - metadata: $.metadata
          - spec: $.spec
          - status: $.status
    target:
      apiGroup: smf.view.dcontroller.io
      kind: SessionContext

  - name: session-output
    sources:
      - kind: Session
      - apiGroup: smf.view.dcontroller.io
        kind: SessionContext
        labelSelector:
          matchExpressions:
            - key: state
              operator: In
              values: ["Ready", "Rejected"]
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Session.metadata.name, $.SessionContext.metadata.name]
            - "@eq": [$.Session.metadata.namespace, $.SessionContext.metadata.namespace]
      - "@project":
          metadata:
            name: $.Session.metadata.name
            namespace: $.Session.metadata.namespace
            labels: $.Session.metadata.labels
            annotations: $.Session.metadata.annotations
          spec: $.SessionContext.spec
          status:
            guti: $.SessionContext.spec.guti
            suci: $.SessionContext.spec.suci
            networkConfiguration: $.SessionContext.status.networkConfiguration
            qos: $.SessionContext.status.qos
            conditions:
              - "@cond":
                  - "@eq": ["$.SessionContext.metadata.labels.state", Ready]
                  - type: Ready
                    status: "True"
                    reason: SessionSuccessful
                    message: Session successfully established
                  - type: Ready
                    status: "False"
                    reason: SessionFailed
                    message: Session establishment failed
              - type: Validated
                status: $.SessionContext.status.conditions.validated.status
                reason: $.SessionContext.status.conditions.validated.reason
                message: $.SessionContext.status.conditions.validated.message
              - type: PolicyApplied
                status: $.SessionContext.status.conditions.policy.status
                reason: $.SessionContext.status.conditions.policy.reason
                message: $.SessionContext.status.conditions.policy.message
              - type: UPFConfigured
                status: $.SessionContext.status.conditions.upf.status
                reason: $.SessionContext.status.conditions.upf.reason
                message: $.SessionContext.status.conditions.upf.message
    target:
      kind: Session
      
