controllers:
  ##############################
  #
  # TABLE INIT
  #
  ##############################
  - name: init-supi-to-guti-table
    sources:
      - kind: InitSupiToGutiTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: supi-to-guti
          spec:
            - supi: "imsi-999010000000123"
              guti: "guti-310-170-3F-152-2A-B7C8D9E0"
            - supi: "imsi-999010000000124"
              guti: "guti-310-170-3F-152-2A-B7C8D9E1"
            - supi: "test-imsi-000000000000000"
              guti: "test-guti-000000000000000"
              
    target:
      kind: SupiToGutiTable

  - name: init-active-registration-table
    sources:
      - kind: InitActiveRegistrationTable
        type: OneShot
    pipeline:
      - "@project":
          metadata:
            name: test-registration
            namespace: test-registration
          spec:
            registrationType: initial
            mobileIdentity:
              type: SUCI
              value: "test-suci-000000000000000"
            ueSecurityCapability:
              encryptionAlgorithms: ["5G-EA2"]
              integrityAlgorithms: ["5G-IA2"]
            ueStatus:
              n1Mode: true
            requestedNSSAI:
              - sliceType: eMBB
                sliceDifferentiator: "000001"
          status:
            guti: "test-guti-000000000000000"
            conditions:
              validated:
                status: "True"
    target:
      kind: RegState

  ##############################
  #
  # Registration controllers: RegState
  # - state: Rejected | Initialized | IdentityResolved | Ready
  # - status: Validated, Authenticated, SubscriptionInfo
  #
  ##############################
  - name: register-input
    sources:
      - kind: Registration
        predicate: GenerationChanged
    pipeline:
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            conditions:
              authenticated: { status: Unknown, message: Pending, reason: Pending }
              validated: { status: Unknown, message: Pending, reason: Pending }
              subscriptionInfo: { status: Unknown, message: Pending, reason: Pending }
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            "@cond":
              - "@eq": ["$.spec.registrationType", "initial"]
              - "@cond":
                  - "@eq": [$.spec.ueStatus.n1Mode, true]
                  - "@cond":
                      - "@gt":
                          - "@len":
                              "@filter": [ {"@eq": ["$$.sliceType", "eMBB"]}, "$.spec.requestedNSSAI"]
                          - 0
                      - "@cond":
                          - "@and":
                              - "@eq": [$.spec.mobileIdentity.type, SUCI]
                              - "@not": { "@isnil": $.spec.mobileIdentity.value }
                          - "@cond":
                              - "@and":
                                  - "@in": [5G-EA2, $.spec.ueSecurityCapability.encryptionAlgorithms]
                                  - "@in": [5G-IA2, $.spec.ueSecurityCapability.integrityAlgorithms]
                              - conditions:
                                  validated:
                                    status: "True"
                                    reason: Validated
                                    message: Validated
                                  authenticated: $.status.conditions.authenticated
                                  subscriptionInfo: $.status.conditions.subscriptionInfo
                              - conditions:
                                  validated:
                                    status: "False"
                                    reason: EncyptionNotSupported
                                    message: Encryption or integrity algorithm not supported
                                  authenticated: $.status.conditions.authenticated
                                  subscriptionInfo: $.status.conditions.subscriptionInfo
                          - conditions:
                              validated:
                                status: "False"
                                reason: SuciNotFound
                                message: "Mobile identity is not provided: SUCI not found"
                              authenticated: $.status.conditions.authenticated
                              subscriptionInfo: $.status.conditions.subscriptionInfo
                      - conditions:
                          validated:
                            status: "False"
                            reason: SuciNotFound
                            message: "Mobile identity is not provided: SUCI not found"
                          authenticated: $.status.conditions.authenticated
                          subscriptionInfo: $.status.conditions.subscriptionInfo
                  - conditions:
                      validated:
                        status: "False"
                        reason: StandardNotSupported
                        message: 5G standard not supported
                      authenticated: $.status.conditions.authenticated
                      subscriptionInfo: $.status.conditions.subscriptionInfo
              - conditions:
                  validated:
                    status: "False"
                    reason: InvalidType
                    message: "Invalid registration type: Only initial registration is supported"
                  authenticated: $.status.conditions.authenticated
                  subscriptionInfo: $.status.conditions.subscriptionInfo
    target:
      kind: RegState

  - name: register-identity-req
    sources:
      - kind: RegState
    pipeline:
      - "@select":
          "@eq": [$.status.conditions.validated.status, "True"]
      - "@project":
          metadata:
            name: $.metadata.name
            namespace: $.metadata.namespace
          spec:
            suci: $.spec.mobileIdentity.value
    target:
      apiGroup: ausf.view.dcontroller.io
      kind: MobileIdentity

  - name: register-identity-handler
    sources:
      - kind: RegState
      - apiGroup: ausf.view.dcontroller.io
        kind: MobileIdentity
      - kind: SupiToGutiTable
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.status.conditions.validated.status, "True"]
            - "@eq": [$.MobileIdentity.metadata.labels.state, Ready]
            - "@eq": [$.RegState.metadata.name, $.MobileIdentity.metadata.name]
            - "@eq": [$.RegState.metadata.namespace, $.MobileIdentity.metadata.namespace]
      - "@project":
          metadata: $.RegState.metadata
          spec: $.RegState.spec
          status:
            "@cond":
              - "@eq": [ "$.MobileIdentity.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - "@cond":
                  - "@has": "$.SupiToGutiTable.spec[?(@.supi == $.MobileIdentity.status.supi)]"
                  - conditions:
                      authenticated:
                        status: "True"
                        reason: AuthenticationSuccess
                        message: UE successfully authenticated
                      subscriptionInfo: $.RegState.status.conditions.subscriptionInfo
                      validated: $.RegState.status.conditions.validated
                    guti: "$.SupiToGutiTable.spec[?(@.supi == $.MobileIdentity.status.supi)].guti"
                    config: $.RegState.status.config
                  - conditions:
                      authenticated:
                        status: "False"
                        reason: MobileIdentityFailed
                        message: "Failed to establish mobile identify: Could not find GUTI"
                      subscriptionInfo: $.RegState.status.conditions.subscriptionInfo
                      validated: $.RegState.status.conditions.validated
                    guti: $.RegState.status.guti
                    config: $.RegState.status.config
              - conditions:
                  authenticated:
                    status: "False"
                    reason: SupiNotFound
                    message: "Failed to establish mobile identify: SUPI not found"
                  validated: $.RegState.status.conditions.validated
                  subscriptionInfo: $.RegState.status.conditions.subscriptionInfo
                guti: $.RegState.status.guti
                config: $.RegState.status.config
    target:
      kind: RegState

  - name: register-config-req
    sources:
      - kind: RegState
    pipeline:
      - "@select":
          "@and":
            - "@eq": [$.status.conditions.validated.status, "True"]
            - "@eq": [$.status.conditions.authenticated.status, "True"]
      - "@project":
          metadata:
            name: $.status.guti
            namespace: $.metadata.namespace
    target:
      apiGroup: udm.view.dcontroller.io
      kind: Config

  - name: register-config-handler
    sources:
      - kind: RegState
      - apiGroup: udm.view.dcontroller.io
        kind: Config
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.RegState.status.conditions.validated.status, "True"]
            - "@eq": [$.RegState.status.conditions.authenticated.status, "True"]
            - "@eq": [$.Config.metadata.labels.state, Ready]
            - "@eq": [$.Config.metadata.name, $.RegState.status.guti]
            - "@eq": [$.Config.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          metadata: $.RegState.metadata
          spec: $.RegState.spec
          status:
            "@cond":
              - "@eq": [ "$.Config.status.conditions[?(@.type == 'Ready')].status", "True" ]
              - config:
                  "@cond":
                    - "@exists": $.RegState.status.config
                    - $.RegState.status.config
                    - $.Config.status.config
                guti: $.RegState.status.guti
                conditions:
                  subscriptionInfo:
                    status: "True"
                    reason: ConfigReady
                    message: UE config successfully loaded
                  authenticated: $.RegState.status.conditions.authenticated
                  validated: $.RegState.status.conditions.validated
              - conditions:
                  subscriptionInfo:
                    status: "False"
                    reason: ConfigNotFound
                    message:
                      "@concat":
                        - "Failed to load subscription info: "
                        - "$.Config.status.conditions[?(@.type == 'Ready')].status.message"
                  authenticated: $.RegState.status.conditions.authenticated
                  validated: $.RegState.status.conditions.validated
    target:
      kind: RegState

  - name: register-output
    sources:
      - kind: Registration
        predicate: GenerationChanged
      - kind: RegState
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Registration.metadata.name, $.RegState.metadata.name]
            - "@eq": [$.Registration.metadata.namespace, $.RegState.metadata.namespace]
      - "@project":
          metadata:
            name: $.RegState.metadata.name
            namespace: $.RegState.metadata.namespace
            labels: $.Registration.metadata.labels
            annotations: $.Registration.metadata.annotations
          spec: $.RegState.spec
          status:
            config: $.RegState.status.config
            guti: $.RegState.status.guti
            allowedNSSAI:
              "@filter": [ {"@eq": ["$$.sliceType", "eMBB"]}, "$.RegState.spec.requestedNSSAI"]
            conditions:
              - "@cond":
                  - "@and":
                      - "@eq": [$.RegState.status.conditions.authenticated.status, "True"]
                      - "@eq": [$.RegState.status.conditions.validated.status, "True"]
                      - "@eq": [$.RegState.status.conditions.subscriptionInfo.status, "True"]
                  - type: Ready
                    status: "True"
                    reason: RegistrationSuccessful
                    message: Registration successful
                  - type: Ready
                    status: "False"
                    reason: RegistrationFailed
                    message: Registration failed
              - type: Validated
                status: $.RegState.status.conditions.validated.status
                reason: $.RegState.status.conditions.validated.reason
                message: $.RegState.status.conditions.validated.message
              - type: Authenticated
                status: $.RegState.status.conditions.authenticated.status
                reason: $.RegState.status.conditions.authenticated.reason
                message: $.RegState.status.conditions.authenticated.message
              - type: SubscriptionInfoRetrieved
                status: $.RegState.status.conditions.subscriptionInfo.status
                reason: $.RegState.status.conditions.subscriptionInfo.reason
                message: $.RegState.status.conditions.subscriptionInfo.message
    target:
      kind: Registration

  - name: active-registration
    sources:
      - kind: RegState
    pipeline:
      - "@select":
          "@and":
            - "@eq": [$.status.conditions.authenticated.status, "True"]
            - "@eq": [$.status.conditions.validated.status, "True"]
            - "@eq": [$.status.conditions.subscriptionInfo.status, "True"]
      - "@project":
          type: RegState
          metadata: $.metadata
          spec:
            name: $.metadata.name
            namespace: $.metadata.namespace
            suci: $.spec.mobileIdentity.value
            guti: $.status.guti
      - "@gather":
          - $.type
          - $.spec
      - "@project":
          metadata:
            name: active-registrations
          spec: $.spec
    target:
      kind: ActiveRegistrationTable

  ##############################
  #
  # Session controllers
  # - state: Rejected | Validated | Registered | IdentityResolved | Ready
  # - status: PolicyApplied, UPFConfigured, Ready
  #
  # ##############################
  - name: session-input
    sources:
      - kind: Session
        predicate: GenerationChanged
      - kind: SupiToGutiTable
      - kind: ActiveRegistrationTable
    pipeline:
      - "@join": true
      - "@project":
          metadata: $.Session.metadata
          spec: $.Session.spec
          status:
            conditions:
              validated: { status: Unknown, message: Pending, reason: Pending }
              policy: { status: Unknown, message: Pending, reason: Pending }
              upf: { status: Unknown, message: Pending, reason: Pending }
          guti2Supi: $.SupiToGutiTable.spec
          activeRegistrations: $.ActiveRegistrationTable.spec
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            "@cond":
              - "@or":
                  - "@isnil": $.spec.networkConfiguration
                  - "@isnil": $.spec.qos
                  - "@isnil": $.spec.qos.flows
                  - "@isnil": $.spec.qos.rules
              - conditions:
                  validated:
                    status: "False"
                    reason: InvalidSession
                    message: Failed to validate Session spec
                  policy: $.status.conditions.policy
                  upf: $.status.conditions.upf
              - "@cond":
                  - "@not": { "@eq": [ $.spec.nssai, eMBB ]}
                  - conditions:
                      validated:
                        status: "False"
                        reason: NSSAINotPermitted
                        message: Network slice not permitted
                      policy: $.status.conditions.policy
                      upf: $.status.conditions.upf
                  - "@cond":
                      - "@isnil": $.spec.guti
                      - conditions:
                          validated:
                            status: "False"
                            reason: GUTINotSpeficied
                            message: GUTI not specified
                          policy: $.status.conditions.policy
                          upf: $.status.conditions.upf
                      - "@cond":
                          - "@isnil": "$.activeRegistrations[?(@.guti == $.spec.guti)]"
                          - conditions:
                              validated:
                                status: "False"
                                reason: Unregistered
                                message: Registration not found
                              policy: $.status.conditions.policy
                              upf: $.status.conditions.upf
                          - "@cond":
                              - "@isnil": "$.guti2Supi[?(@.guti == $.spec.guti)]"
                              - conditions:
                                  validated:
                                    status: "False"
                                    reason: SUPINotFound
                                    message: SUPI not found
                                  policy: $.status.conditions.policy
                                  upf: $.status.conditions.upf
                              - conditions:
                                  validated:
                                    status: "True"
                                    reason: Validated
                                    message: Session request validated
                                  policy: $.status.conditions.policy
                                  upf: $.status.conditions.upf
                                supi: "$.guti2Supi[?(@.guti == $.spec.guti)].supi"
                                guti: $.spec.guti
                                suci: "$.activeRegistrations[?(@.guti == $.spec.guti)].suci"
      - "@project": # remove tables
          metadata: $.metadata
          spec: $.spec
          status: $.status
    target:
      apiGroup: smf.view.dcontroller.io
      kind: SessionContext

  - name: session-output
    sources:
      - kind: Session
      - apiGroup: smf.view.dcontroller.io
        kind: SessionContext
    pipeline:
      - "@join":
          "@and":
            - "@eq": [$.Session.metadata.name, $.SessionContext.metadata.name]
            - "@eq": [$.Session.metadata.namespace, $.SessionContext.metadata.namespace]
      - "@project":
          metadata:
            name: $.Session.metadata.name
            namespace: $.Session.metadata.namespace
            labels: $.Session.metadata.labels
            annotations: $.Session.metadata.annotations
          spec: $.SessionContext.spec
          status:
            guti: $.SessionContext.spec.guti
            suci: $.SessionContext.status.suci
            networkConfiguration: $.SessionContext.status.networkConfiguration
            qos: $.SessionContext.status.qos
            conditions:
              - "@cond":
                  - "@and":
                      - "@eq": ["$.SessionContext.status.conditions.validated.status", "True"]
                      - "@eq": ["$.SessionContext.status.conditions.policy.status", "True"]
                      - "@eq": ["$.SessionContext.status.conditions.upf.status", "True"]
                  - type: Ready
                    status: "True"
                    reason: SessionSuccessful
                    message: Session successfully established
                  - type: Ready
                    status: "False"
                    reason: SessionFailed
                    message: Session establishment failed
              - type: Validated
                status: $.SessionContext.status.conditions.validated.status
                reason: $.SessionContext.status.conditions.validated.reason
                message: $.SessionContext.status.conditions.validated.message
              - type: PolicyApplied
                status: $.SessionContext.status.conditions.policy.status
                reason: $.SessionContext.status.conditions.policy.reason
                message: $.SessionContext.status.conditions.policy.message
              - type: UPFConfigured
                status: $.SessionContext.status.conditions.upf.status
                reason: $.SessionContext.status.conditions.upf.reason
                message: $.SessionContext.status.conditions.upf.message
    target:
      kind: Session

  - name: session-context-release-input
    sources:
      - kind: ContextRelease
        predicate: GenerationChanged
      - kind: ActiveRegistrationTable
      - apiGroup: smf.view.dcontroller.io
        kind: ActiveSessionTable
    pipeline:
      - "@join": true
      - "@project":
          metadata: $.ContextRelease.metadata
          spec: $.ContextRelease.spec
          activeRegistrations: $.ActiveRegistrationTable.spec
          activeSessions: $.ActiveSessionTable.spec
      - "@project":
          metadata: $.metadata
          spec: $.spec
          status:
            "@cond":
              - "@isnil": "$.spec.guti"
              - conditions:
                  - type: Ready
                    status: "False"
                    reason: GutiNotSpecified
                    message: GUTI not specified
              - "@cond":
                  - "@isnil": "$.activeRegistrations[?(@.guti == $.spec.guti)]"
                  - conditions:
                      - type: Ready
                        status: "False"
                        reason: GutiNotFound
                        message: GUTI not found
                  - "@cond":
                      - "@isnil": "$.activeSessions[?(@.guti == $.spec.guti && @.sessionId == $.spec.sessionId)]"
                      - conditions:
                          - type: Ready
                            status: "False"
                            reason: SessionNotFound
                            message: Session not found
                      - conditions:
                          - type: Ready
                            status: "True"
                            reason: Ready
                            message: Context release request accepted
      - "@project": # remove tables
          metadata: $.metadata
          spec: $.spec
          status: $.status
    target:
      kind: ContextRelease

  - name: session-context-release-output
    sources:
      - kind: ContextRelease
    pipeline:
      - "@select":
          "@eq": ["$.status.conditions[?(@.type == 'Ready')].status", "True"]
      - "@project":
          metadata:
            name: $.metadata.name
            namespace: $.metadata.namespace
          spec:
            idle: true
    target:
      apiGroup: smf.view.dcontroller.io
      kind: SessionContext
      type: Patcher
